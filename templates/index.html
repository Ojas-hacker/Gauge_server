<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gauge Monitor</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #333;
            color: white;
            padding: 15px;
            border-radius: 5px;
        }
        .header-content h1 {
            margin: 0;
            font-size: 24px;
        }
        .header-content h3 {
            margin: 5px 0 0;
            font-size: 16px;
            font-weight: normal;
        }
        .sync-info {
            font-size: 14px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        .stat-card p {
            margin: 10px 0 0;
            font-size: 24px;
            font-weight: bold;
            color: #555;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        .filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter label {
            font-size: 14px;
            color: #333;
        }
        .filter input[type="date"] {
            padding: 5px;
            font-size: 14px;
        }
        .filter button, .actions button {
            padding: 8px 15px;
            font-size: 14px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .filter button:hover, .actions button:hover {
            background-color: #0056b3;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .chart-section, .readings, .table-section {
            margin: 20px 0;
        }
        .chart-section h2, .readings h3, .table-section h2 {
            margin: 0 0 10px;
            font-size: 20px;
            color: #333;
        }
        .chart-section p, .table-section p {
            margin: 0 0 10px;
            font-size: 14px;
            color: #666;
        }
        #chart-wrapper {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .gauge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .gauge-card {
            background-color: white;
            border: 1px solid #ccc;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .gauge-card h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }
        .gauge-card p {
            margin: 5px 0 0;
            font-size: 20px;
            font-weight: bold;
        }
        .error {
            color: red;
        }
        .warning {
            color: orange;
        }
        .table-wrapper {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table th {
            background-color: #f8f8f8;
            font-weight: bold;
            color: #333;
        }
        .table td .error {
            color: red;
        }
        .table td .warning {
            color: orange;
        }
        .overlay, .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            display: none;
        }
        .toast {
            background-color: #28a745;
        }
    </style>
    <script>
        // Initialize SocketIO
        const socket = io();

        // Set last sync time
        function setLastSync() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('last-sync').textContent = timeString;
        }

        socket.on('csv_update', function(data) {
            setLastSync();
            window.location.reload();
        });

        socket.on('auto_download', function(data) {
            console.log('Received auto download event:', data);
            const link = document.createElement('a');
            link.href = data.url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Automatic download of new data started.');
        });

        function downloadCSV() {
            const dateInput = document.getElementById('date-filter').value;
            let url = '/download_csv';
            if (dateInput) {
                url += '?date=' + dateInput;
            }
            window.location.href = url;
        }

        function downloadAllData() {
            window.location.href = '/download_csv';
        }

        function filterByDate() {
            const date = document.getElementById('date-filter').value;
            if (date) {
                fetch('/data?date=' + date)
                    .then(response => response.json())
                    .then(data => {
                        window.location.reload();
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }
        }

        // Initialize chart
        function createGaugeChart() {
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            const data = {{ data | tojson }};
            if (!data || data.length === 0) return;

            const labels = data.map(row => row.time);
            const datasets = [];
            const gauges = ['gauge-1', 'gauge-2', 'gauge-3', 'gauge-4', 'gauge-5', 'gauge-6', 'gauge-7'];
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];

            gauges.forEach((gauge, index) => {
                datasets.push({
                    label: gauge,
                    data: data.map(row => {
                        const value = row[gauge];
                        return (value !== 'N/A' && value !== 'Unable to read - Processing error') ? parseFloat(value) : null;
                    }),
                    borderColor: colors[index],
                    fill: false
                });
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: 'Time' }
                        },
                        y: {
                            title: { display: true, text: 'Reading' }
                        }
                    }
                }
            });
        }

        window.onload = function() {
            setLastSync();
            createGaugeChart();
        };
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>Gauge Monitor</h1>
                <h3>Industrial Dashboard</h3>
            </div>
            <div class="sync-info">
                Last sync: <span id="last-sync">--:--:--</span>
            </div>
        </header>

        <section class="stats">
            <div class="stat-card">
                <h3>Total Readings</h3>
                <p>{{ data | length }}</p>
            </div>

            <div class="stat-card">
                <h3>Avg Reading</h3>
                <p>
                    {% set total = 0 %}
                    {% set count = 0 %}
                    {% for row in data %}
                        {% for key in ['gauge-1', 'gauge-2', 'gauge-3', 'gauge-4', 'gauge-5', 'gauge-6', 'gauge-7'] %}
                            {% if row[key] | default('N/A') != 'N/A' and row[key] != 'Unable to read - Processing error' %}
                                {% set total = total + (row[key] | float) %}
                                {% set count = count + 1 %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    {% if count > 0 %}
                        {{ (total / count) | round(2) }}
                    {% else %}
                        0
                    {% endif %}
                </p>
            </div>

            <div class="stat-card">
                <h3>High Alerts</h3>
                <p>
                    {% set alerts = 0 %}
                    {% for row in data %}
                        {% for key in ['gauge-1', 'gauge-2', 'gauge-3', 'gauge-4', 'gauge-5', 'gauge-6', 'gauge-7'] %}
                            {% if row[key] | default('N/A') != 'N/A' and row[key] != 'Unable to read - Processing error' and row[key] | float > 80 %}
                                {% set alerts = alerts + 1 %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    {{ alerts }}
                </p>
            </div>
        </section>

        <section class="controls">
            <div class="filter">
                <label for="date-filter">Filter by Date</label>
                <input type="date" id="date-filter">
                <button onclick="filterByDate()">Filter</button>
            </div>

            <div class="actions">
                <button onclick="window.location.reload()">Refresh</button>
                <button onclick="downloadCSV()">Download CSV</button>
                <button onclick="downloadAllData()">Download All Data</button>
            </div>
        </section>

        <section class="chart-section">
            <h2>Latest 10 Readings Trend</h2>
            <p>Real-time gauge readings visualization</p>
            <div id="chart-wrapper">
                <canvas id="gaugeChart"></canvas>
            </div>
        </section>

        <section class="readings">
            <h3>Gauge Readings</h3>
            <div class="gauge-grid">
                {% for i in range(1, 8) %}
                    <div class="gauge-card">
                        <h3>Gauge {{ i }}</h3>
                        <p>
                            {% if data %}
                                {% set latest = data[0] %}
                                {% set value = latest['gauge-' + i|string] | default('N/A') %}
                                {% if value != 'N/A' and value != 'Unable to read - Processing error' %}
                                    {% if value|float > 80 %}
                                        <span class="error">{{ value }}</span>
                                    {% elif value|float > 60 %}
                                        <span class="warning">{{ value }}</span>
                                    {% else %}
                                        <span>{{ value }}</span>
                                    {% endif %}
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                {% endfor %}
            </div>
        </section>

        <section class="table-section">
            <h2>Recent Readings</h2>
            <p>Real-time gauge data monitoring</p>
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            {% for key in ['time', 'gauge-1', 'gauge-2', 'gauge-3', 'gauge-4', 'gauge-5', 'gauge-6', 'gauge-7'] %}
                                <th>
                                    {% if key == 'time' %}
                                        {{ key | title }}
                                    {% else %}
                                        {{ key }}
                                    {% endif %}
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                            <tr>
                                {% for key in ['time', 'gauge-1', 'gauge-2', 'gauge-3', 'gauge-4', 'gauge-5', 'gauge-6', 'gauge-7'] %}
                                    <td>
                                        {% if key == 'time' %}
                                            {{ row[key] | default('N/A') }}
                                        {% else %}
                                            {% set value = row[key] | default('N/A') %}
                                            {% if value != 'N/A' and value != 'Unable to read - Processing error' %}
                                                {% if value|float > 80 %}
                                                    <span class="error">{{ value }}</span>
                                                {% elif value|float > 60 %}
                                                    <span class="warning">{{ value }}</span>
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            {% else %}
                                                {{ value }}
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="loading" class="overlay">
        <p>Loading data...</p>
    </div>

    <div id="success-toast" class="toast">
        <p>Data updated successfully</p>
    </div>
</body>
</html>
