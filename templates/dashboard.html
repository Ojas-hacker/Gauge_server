<!DOCTYPE html>
<html>
<head>
    <title>Gauge Readings Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="mt-4">Gauge Readings Dashboard</h1>
        <button id="manual-download" class="btn btn-primary mb-3">Download Today's Data</button>
        <div id="download-status" class="alert alert-info" style="display: none;"></div>
        <ul class="nav nav-tabs" id="panelTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="panel1-tab" data-toggle="tab" href="#panel1" role="tab">Panel 1</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="panel2-tab" data-toggle="tab" href="#panel2" role="tab">Panel 2</a>
            </li>
        </ul>
        <div class="tab-content" id="panelTabsContent">
            <div class="tab-pane fade show active" id="panel1" role="tabpanel">
                <h2 class="mt-3">Panel 1 Readings</h2>
                <table class="table" id="panel1-table">
                    <thead>
                        <tr>
                            <th>Gauge</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be added by JavaScript -->
                    </tbody>
                </table>
                <h3>Historical Data (Last Hour)</h3>
                <canvas id="panel1-chart"></canvas>
            </div>
            <div class="tab-pane fade" id="panel2" role="tabpanel">
                <h2 class="mt-3">Panel 2 Readings</h2>
                <table class="table" id="panel2-table">
                    <thead>
                        <tr>
                            <th>Gauge</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be added by JavaScript -->
                    </tbody>
                </table>
                <h3>Historical Data (Last Hour)</h3>
                <canvas id="panel2-chart"></canvas>
            </div>
        </div>
    </div>
    <script>
        function updateTable(tableId, reading) {
            var tableBody = $('#' + tableId + ' tbody');
            tableBody.empty();
            if (reading && Object.keys(reading).length > 0) {
                console.log('Updating table', tableId, 'with:', reading);
                for (var key in reading) {
                    if (key !== 'timestamp' && key !== '_id' && key !== 'panel') {
                        tableBody.append('<tr><td>' + key.replace('_', ' ').toUpperCase() + '</td><td>' + reading[key] + '</td></tr>');
                    }
                }
            } else {
                console.log('No data for table', tableId);
                tableBody.append('<tr><td colspan="2">No data available</td></tr>');
            }
        }

        function updateChart(chartId, panel) {
            var ts = new Date().getTime();
            $.getJSON('http://127.0.0.1:5000/historical_data?panel=' + panel + '&hours=1&_=' + ts, function(data) {
                console.log('Historical data for panel ' + panel + ':', data);
                if (data.length > 0) {
                    var labels = data.map(function(d) { return d.timestamp; });
                    var datasets = [];
                    var gauges = Object.keys(data[0]).filter(function(key) { return key !== 'timestamp'; });
                    gauges.forEach(function(gauge, index) {
                        datasets.push({
                            label: gauge.replace('_', ' ').toUpperCase(),
                            data: data.map(function(d) { 
                                var value = d[gauge];
                                if (typeof value === 'string') {
                                    value = parseFloat(value.split(' ')[0]) || 0;
                                }
                                return isNaN(value) ? 0 : value;
                            }),
                            borderColor: 'hsl(' + (index * 360 / gauges.length) + ', 100%, 50%)',
                            fill: false
                        });
                    });
                    var ctx = document.getElementById(chartId).getContext('2d');
                    if (window[chartId + 'Chart']) {
                        window[chartId + 'Chart'].destroy();
                    }
                    window[chartId + 'Chart'] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'minute'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Value'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.log('No historical data for panel ' + panel);
                    var ctx = document.getElementById(chartId).getContext('2d');
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Arial';
                    ctx.fillText('No data available', 10, 50);
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Error fetching historical data for panel ' + panel + ':', textStatus, errorThrown);
            });
        }

        function initializeDashboard() {
            var ts = new Date().getTime();
            $.getJSON('http://127.0.0.1:5000/latest_readings?_=' + ts, function(data) {
                console.log('Initial readings:', data);
                updateTable('panel1-table', data.panel1);
                updateTable('panel2-table', data.panel2);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Error fetching initial readings:', textStatus, errorThrown);
            });
            updateChart('panel1-chart', 1);
            updateChart('panel2-chart', 2);
        }

        function checkAndDownloadCsv() {
            var now = moment().tz('Asia/Kolkata');
            var isDownloadTime = now.hour() === 13 && now.minute() >= 0 && now.minute() < 5; // Check between 1:00-1:05 PM IST
            if (isDownloadTime) {
                $.getJSON('http://127.0.0.1:5000/list_csv_files', function(data) {
                    if (data.files && data.files.length > 0) {
                        $('#download-status').text(`Downloading ${data.files.length} CSV file(s)...`).show();
                        data.files.forEach(function(filename) {
                            var link = document.createElement('a');
                            link.href = 'http://127.0.0.1:5000/download_csv/' + filename;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        });
                        setTimeout(function() {
                            $('#download-status').text('Download complete!').fadeOut(3000);
                        }, 2000);
                    } else {
                        $('#download-status').text('No new CSV files available.').show().fadeOut(3000);
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching CSV files:', textStatus, errorThrown);
                    $('#download-status').text('Error fetching CSV files.').show().fadeOut(3000);
                });
            }
        }

        $('#manual-download').click(function() {
            $.getJSON('http://127.0.0.1:5000/list_csv_files', function(data) {
                if (data.files && data.files.length > 0) {
                    $('#download-status').text(`Downloading ${data.files.length} CSV file(s)...`).show();
                    data.files.forEach(function(filename) {
                        var link = document.createElement('a');
                        link.href = 'http://127.0.0.1:5000/download_csv/' + filename;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                    setTimeout(function() {
                        $('#download-status').text('Download complete!').fadeOut(3000);
                    }, 2000);
                } else {
                    $('#download-status').text('No new CSV files available.').show().fadeOut(3000);
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Error fetching CSV files:', textStatus, errorThrown);
                $('#download-status').text('Error fetching CSV files.').show().fadeOut(3000);
            });
        });

        var source = new EventSource('http://127.0.0.1:5000/stream_readings');
        source.onmessage = function(event) {
            var data = JSON.parse(event.data);
            console.log('SSE update received:', data);
            if (data.panel1) {
                updateTable('panel1-table', data.panel1);
                updateChart('panel1-chart', 1);
            }
            if (data.panel2) {
                updateTable('panel2-table', data.panel2);
                updateChart('panel2-chart', 2);
            }
        };
        source.onerror = function(err) {
            console.error('SSE error:', err);
            source.close();
            setInterval(initializeDashboard, 5000);
        };

        initializeDashboard();
        setInterval(checkAndDownloadCsv, 60000); // Check every minute
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
</body>
</html>
